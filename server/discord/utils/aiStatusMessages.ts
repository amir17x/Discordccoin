/**
 * ุณุณุชู ุชููุฏ ุฌููุงุช ุทูุฒ ู ุณุฑฺฏุฑูโฺฉููุฏู ุชูุณุท ููุด ูุตููุน
 * ุงู ูุงฺูู ุจุฑุง ุชููุฏ ุฌููุงุช ุทูุฒ ู ุณุฑฺฏุฑูโฺฉููุฏู ุจุฑุง ููุงุด ุฏุฑ ุจุฎุด Watching ุฑุจุงุช ุงุณุชูุงุฏู ูโุดูุฏ
 */

import { generateAIResponse } from '../services/aiService';
import { log } from '../../vite';

/**
 * ูุณุช ุฌููุงุช ูพุดโูุฑุถ ฺฉูุชุงู ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ ุตูุฑุช ุฎุทุง ุฏุฑ ููุด ูุตููุน
 */
const defaultFunnyStatuses = [
  "ูพุงุชฺฉ ุจู ุฑุฎุชโูุง! ๐งฆ",
  "ูุงฺฉ ฺฉุฑุฏู ุงุณุชูุฑโูุง! โค๏ธ",
  "ูุฑุฎโูุง ุฑูุช ุจุงูุง! ๐",
  "ุบุฑู ุฏุฑ ุณฺฉูโูุง! ๐",
  "ุจุฑุฌโุณุงุฒ ุจุง ุณฺฉู! ๐ข",
  "ุงูููู ุณฺฉู! ๐ค",
  "ุณฺฉูโูุง ฺุดูฺฉโุฒู! โจ",
  "ุฑูุต ุจุง ฺฏุงูโูุง ุจูุฑุณ! ๐",
  "ุดุงู ฺฉู ูพููโูุง! ๐",
  "ููุนูโุณุงุฒ ุจุง ุณฺฉู! ๐ฐ",
  "ููุจุช ุดูุงุณุช! ๐ฏ",
  "ุณุงุฎุช ุงูุชุตุงุฏ ูู! ๐",
  "ุฌุณุชุฌู ฺฏูุฌ! ๐บ๏ธ",
  "ุชุนู ููุช ฺฉูู! ๐",
  "ุฏุฑ ูุงููุฑุช! ๐ต๏ธโโ๏ธ",
  "ฺฉุณู ุณฺฉู ูพุฏุง ฺฉุฑุฏู! ๐คซ",
  "ูุถุงุนู ฺฉุฑุฏู ุณฺฉูโูุง! ๐ฐ",
  "ูุฑุฎโูุง ุฑูุช ูพุงู! ๐",
  "ุดูุงุฑุด ุญุณุงุจโูุง! ๐งฎ",
  "ฺุฑุช ุฒุฏู ุจุง ุงูฺฏูุฑุชูโูุง! ๐ด",
  "ุณููุท ุขุฒุงุฏ ููุชโูุง! ๐ข",
  "ุดฺฉุงุฑ ูุญุธูโูุง ุทูุง! ๐ฐ",
  "ุจุชโฺฉูู ุฏุฒุฏุฏู! ๐โโ๏ธ",
  "ุจู ุฏูุจุงู ุงุฑุฏุฑุงูพโูุง! ๐ช",
  "ุชุฌุงุฑุช ุจุง ฺฉูุงูุจุฑุฏุงุฑุงู! ๐ญ",
  "ุฏุณุช ฺฉุฑุฏู ุชู ุฌุจ NFTูุง! ๐ผ๏ธ",
  "ููฺฏ ฺฉุฑุฏู ุตุฑุงูโูุง! ๐ง",
  "ูพููโุดู ุจุง ุณฺฉูู! ๐งผ",
  "ูุฑุงุฑ ุงุฒ ูุงูุงุช! ๐โโ๏ธ",
  "ุณฺฉูโูุง ุฑุง ูุงู ฺฉุฑุฏู! ๐",
  "ุฏุฒุฏฺฉ ูโุจููุชูู! ๐",
  "ุฏุฑ ุญุงู ุฏูุงุน ุงุฒ ฺฏุงู ุจุงุฒุงุฑ! ๐ก๏ธ",
  "ุดุงุฑฺ ฺฉู ูพููโูุง ุดูุง! ๐",
  "ุฏูุชุฑ ุงุฏุฏุงุดุช ูููฺฏโูุง! ๐",
  "ููุชโฺฏุฐุงุฑ ุณฺฉูู! ๐",
  "ูุงููฺฏ ุจุง ูพูโุงุณุชุดู! ๐ฎ",
  "NFT ููโูุง ุฑุง ูโุฎุฑู! ๐คฃ",
  "ุจุง ุดูุฑุช ุจุชโฺฉูู ุงููุฏู! ๐ฉณ",
  "ูพุงููพ ููุชโูุง! ๐",
  "ฺฉู ุจุงุฒุงุฑ ูโุฎุฑู! ๐"
];

/**
 * ุชูโูุง ูุฎุชูู ุจุฑุง ุชููุฏ ุฌููุงุช
 */
export const messageThemes = [
  'ุทูุฒ ุงูุชุตุงุฏ',
  'ุจุงุฒ ู ุณุฑฺฏุฑู',
  'ุดูุฎโูุง ุงูุชุฑูุช',
  'ุทูุฒ ุฑูุฒูุฑู',
  'ุฑูุงุจุช ู ฺุงูุด',
  'ููโูุง ฺฉุฑูพุชู',
  'ุซุฑูุช ู ูพูู',
  'ุนุจุงุฑุงุช ูุงูุชุนุงุฑู',
  'ุฏุฒุฏ ู ุณุฑูุช',
  'ุดูุฎโูุง ฺฏูุฑ',
  'ุจูุฑุณ ู ุณูุงู',
  'ูุนุงููุงุช ุฑูุฒุงูู',
  'ฺฉููโูุง ุฏุฌุชุงู',
  'ููุงุฑ ู ุดุฑุทโุจูุฏ',
  'ฺฉุณุจ ุฏุฑุขูุฏ ุงูุชุฑูุช',
  'ูุงููุฑุชโูุง ูุฎู',
  'ูุฑูุดฺฏุงู ู ุฎุฑุฏ',
  'ุงูุชุงุฒุงุช ูฺู',
  'ุฌูุงุฒ ุฑูุฒุงูู',
  'ุฑุชุจูโุจูุฏ ุจุงุฒฺฉูุงู',
  'ุฏุณุชูุฑุงุช ุงุณูุด',
  'ููู ุงูุชุตุงุฏ',
  'ุชูโูุง ู ฺฉููโูุง',
  'ุฌูฺฏ ู ุฑูุงุจุช',
  'ูุงุชุงุฑ ู ุดุงูุณ'
];

/**
 * ุฐุฎุฑูโุณุงุฒ ูพุงูโูุง ุทูุฒ ุจุฑุง ฺฉุงูุด ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุชโูุง ุจู ููุด ูุตููุน
 * ูุฑ ุชู ุญุฏุงฺฉุซุฑ 5 ูพุงู ุฐุฎุฑู ุดุฏู ุฏุงุฑุฏ
 */
const themeCachedMessages: { [key: string]: string[] } = {};

/**
 * ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ูพุงู ุฐุฎุฑู ุดุฏู ุจุฑุง ูุฑ ุชู
 */
const MAX_CACHED_MESSAGES_PER_THEME = 5;

/**
 * ุชููุฏ ฺฉ ุฌููู ุทูุฒ ุจุง ุงุณุชูุงุฏู ุงุฒ ููุด ูุตููุน
 * @returns ฺฉ ุฌููู ุทูุฒ ุชููุฏ ุดุฏู ุชูุณุท ููุด ูุตููุน
 */
export async function generateFunnyStatusMessage(): Promise<string> {
  try {
    // ุงูุชุฎุงุจ ฺฉ ุชู ุงุชูุงู
    const randomTheme = messageThemes[Math.floor(Math.random() * messageThemes.length)];
    
    // ุงฺฏุฑ ุงุฒ ุงู ุชู ูพุงูโูุง ฺฉุด ุดุฏู ุฏุงุฑูุ ฺฉ ุฑุง ุจุฑฺฏุฑุฏุงูู
    if (themeCachedMessages[randomTheme] && themeCachedMessages[randomTheme].length > 0) {
      // ุงูุชุฎุงุจ ฺฉ ูพุงู ุชุตุงุฏู ุงุฒ ฺฉุด
      const randomIndex = Math.floor(Math.random() * themeCachedMessages[randomTheme].length);
      const message = themeCachedMessages[randomTheme][randomIndex];
      
      // ุญุฐู ูพุงู ุงุณุชูุงุฏู ุดุฏู ุงุฒ ฺฉุด
      themeCachedMessages[randomTheme].splice(randomIndex, 1);
      
      log(`ุงุณุชูุงุฏู ุงุฒ ูพุงู ฺฉุด ุดุฏู ุจุฑุง ุชู "${randomTheme}": "${message}"`, 'info');
      return message;
    }
    
    // ุณุงุฎุช ูพุฑุงููพุช ุจููู ุดุฏู ุจุฑุง ููู ุณุฑูุณโูุง ููุด ูุตููุน
    const prompt = `ุณุณุชู: ุชู ฺฉ ุฑุจุงุช ุชููุฏฺฉููุฏู ุฌููุงุช ุทูุฒ ู ฺฉูุชุงู ุจุฑุง ููุงุด ุฏุฑ ูุถุนุช (Watching Status) ฺฉ ุฑุจุงุช ุฏุณฺฉูุฑุฏ ูุณุช. ุจุฑ ุงุณุงุณ ููุถูุน ุฏุงุฏู ุดุฏูุ ฺูุฏ ุฌููู ุทูุฒ ู ุฌุฐุงุจ ุจู ุฒุจุงู ูุงุฑุณ ุชููุฏ ฺฉู.

ฺฉุงุฑุจุฑ: ูพูุฌ ุฌููู ุฎู ฺฉูุชุงูุ ุทูุฒ ู ุจุงูุฒู ูุงุฑุณ (ูุฑ ฺฉุฏุงู ุฏููุงู ฺฉูุชุฑ ุงุฒ ตฐ ฺฉุงุฑุงฺฉุชุฑ) ุจุฑุง ููุงุด ุฏุฑ ุจุฎุด "Watching" ุฏุฑ ุฑุจุงุช Ccoin (ฺฉ ุจุงุฒ ุงูุชุตุงุฏ ุฏุณฺฉูุฑุฏ) ุชููุฏ ฺฉู. ูุฑ ุฌููู ุฑุง ุฏุฑ ฺฉ ุฎุท ุฌุฏุงฺฏุงูู ุจููุณ.

ููุถูุน: ${randomTheme}

ุดุฑุงุท ููู:
- ูุฑ ุฌููู ุฏููุงู ฺฉูุชุฑ ุงุฒ ตฐ ฺฉุงุฑุงฺฉุชุฑ ุจุงุดุฏ
- ุญุชูุงู ูุงุฑุณ ุจุงุดุฏ ู ูุญู ุทูุฒ ุฏุงุดุชู ุจุงุดุฏ
- ุญุชูุงู ุฏุฑ ูุฑ ุฌููู ฺฉ ุง ุฏู ุงููุฌ ููุงุณุจ ุงุณุชูุงุฏู ฺฉู
- ฺฉููุงุช ู ุงุตุทูุงุญุงุช ุฑุงุฌ ูุงู ฺฏูุฑูุง ู ุฌูุงูุงู ุงุฑุงู ุงุณุชูุงุฏู ฺฉู
- ููุท ู ููุท ต ุฌููู ููุง ุฑุง ุจููุณุ ูุฑ ฺฉุฏุงู ุฏุฑ ฺฉ ุฎุท ุฌุฏุงฺฏุงููุ ุจุฏูู ุดูุงุฑูโฺฏุฐุงุฑ ู ุจุฏูู ูฺ ุชูุถุญ ุงุถุงููโุง
- ุฌููุงุช ุจุงุฏ ุจุงูุฒู ู ุฎูุงูุงูู ุจุงุดูุฏ ุงูุง ุชูููโุขูุฒ ูุจุงุดูุฏ

ููู: ููุท ต ุฌููู ุฑุง ูุฑ ฺฉุฏุงู ุฏุฑ ฺฉ ุฎุท ุฌุฏุงฺฏุงูู ุจููุณ. ุจุฏูู ูฺ ุชูุถุญ ู ููุฏูู ู ุนูุงูุช ููู ููู.`;

    // ุฏุฑุงูุช ูพุงุณุฎ ุงุฒ ููุด ูุตููุน
    const generatedMessages = await generateAIResponse(prompt, "statusMessages");
    
    // ุชูุณู ูพุงุณุฎ ุจู ุฎุทูุท ุฌุฏุงฺฏุงูู
    const messageLines = generatedMessages.split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0 && line.length <= 50);
    
    // ุงฺฏุฑ ูฺ ูพุงู ุฏุฑุงูุช ูุดุฏุ ุงุฒ ูพุงูโูุง ูพุดโูุฑุถ ุงุณุชูุงุฏู ูโฺฉูู
    if (messageLines.length === 0) {
      const fallbackMessage = defaultFunnyStatuses[Math.floor(Math.random() * defaultFunnyStatuses.length)];
      log(`ูฺ ูพุงู ุฏุฑุงูุช ูุดุฏ. ุงุณุชูุงุฏู ุงุฒ ูพุงู ูพุดโูุฑุถ: "${fallbackMessage}"`, 'info');
      return fallbackMessage;
    }
    
    // ุฐุฎุฑู ูพุงูโูุง ุฏุฑ ฺฉุด
    themeCachedMessages[randomTheme] = messageLines.slice(1); // ุฐุฎุฑู ููู ูพุงูโูุง ุจู ุฌุฒ ุงูู
    
    // ูุญุฏูุฏ ฺฉุฑุฏู ุชุนุฏุงุฏ ูพุงูโูุง ุฐุฎุฑู ุดุฏู
    if (themeCachedMessages[randomTheme].length > MAX_CACHED_MESSAGES_PER_THEME) {
      themeCachedMessages[randomTheme] = themeCachedMessages[randomTheme].slice(0, MAX_CACHED_MESSAGES_PER_THEME);
    }
    
    // ุงุณุชูุงุฏู ุงุฒ ุงููู ูพุงู
    const selectedMessage = messageLines[0];
    log(`ุชููุฏ ูพุงู ุทูุฒ ุจุฑุง ุชู "${randomTheme}": "${selectedMessage}"`, 'success');
    return selectedMessage;
    
  } catch (error) {
    log(`ุฎุทุง ุฏุฑ ุชููุฏ ูพุงู ุทูุฒ: ${error}`, 'error');
    
    // ุฏุฑ ุตูุฑุช ุฎุทุงุ ฺฉ ูพุงู ูพุดโูุฑุถ ุจุงุฒฺฏุดุช ูโุฏูู
    const fallbackMessage = defaultFunnyStatuses[Math.floor(Math.random() * defaultFunnyStatuses.length)];
    log(`ุงุณุชูุงุฏู ุงุฒ ูพุงู ูพุดโูุฑุถ: "${fallbackMessage}"`, 'success');
    return fallbackMessage;
  }
}

/**
 * ุชูุธู ุฒูุงูุจูุฏ ุจุฑุง ุจูโุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ ูพุงู ูุถุนุช
 * @param client ฺฉูุงูุช ุฏุณฺฉูุฑุฏ
 * @param intervalMinutes ูุงุตูู ุฒูุงู ุจูโุฑูุฒุฑุณุงู (ุจู ุฏููู)
 */
export function setupAutoStatusUpdater(client: any, intervalMinutes: number = 30) {
  // ุจูโุฑูุฒุฑุณุงู ุงููู ูพุณ ุงุฒ ุฑุงูโุงูุฏุงุฒ
  setTimeout(async () => {
    try {
      updateBotStatus(client);
    } catch (e) {
      log(`ุฎุทุง ุฏุฑ ุจูโุฑูุฒุฑุณุงู ุงููู ูุถุนุช: ${e}`, 'error');
    }
  }, 10000); // 10 ุซุงูู ูพุณ ุงุฒ ุฑุงูโุงูุฏุงุฒ
  
  // ุชูุธู ุจูโุฑูุฒุฑุณุงู ุฏูุฑูโุง
  setInterval(async () => {
    try {
      updateBotStatus(client);
    } catch (e) {
      log(`ุฎุทุง ุฏุฑ ุจูโุฑูุฒุฑุณุงู ุฏูุฑูโุง ูุถุนุช: ${e}`, 'error');
    }
  }, intervalMinutes * 60 * 1000);
  
  log(`ุณุณุชู ุจูโุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ ูุถุนุช ุจุง ูุงุตูู ${intervalMinutes} ุฏููู ุฑุงูโุงูุฏุงุฒ ุดุฏ`, 'info');
}

/**
 * ุจูโุฑูุฒุฑุณุงู ูุถุนุช ููุงุด ุฑุจุงุช
 * @param client ฺฉูุงูุช ุฏุณฺฉูุฑุฏ
 */
async function updateBotStatus(client: any) {
  try {
    const statusMessage = await generateFunnyStatusMessage();
    
    // ุชูุธู ูุถุนุช ุฌุฏุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ ActivityType
    client.user.setActivity(statusMessage, { type: 3 }); // 3 = WATCHING
    
    log(`ูุถุนุช ุฑุจุงุช ุจูโุฑูุฒุฑุณุงู ุดุฏ: ${statusMessage}`, 'info');
  } catch (error) {
    log(`ุฎุทุง ุฏุฑ ุจูโุฑูุฒุฑุณุงู ูุถุนุช ุฑุจุงุช: ${error}`, 'error');
    
    // ุงุณุชูุงุฏู ุงุฒ ฺฉ ูพุงู ูพุดโูุฑุถ ุฏุฑ ุตูุฑุช ุฎุทุง
    try {
      const fallbackMessage = defaultFunnyStatuses[Math.floor(Math.random() * defaultFunnyStatuses.length)];
      client.user.setActivity(fallbackMessage, { type: 3 }); // 3 = WATCHING
      log(`ุงุณุชูุงุฏู ุงุฒ ูพุงู ูพุดโูุฑุถ: ${fallbackMessage}`, 'info');
    } catch (e) {
      log(`ุฎุทุง ุฏุฑ ุชูุธู ูพุงู ูพุดโูุฑุถ: ${e}`, 'error');
    }
  }
}

/**
 * ุจูโุฑูุฒุฑุณุงู ููุฑ ูุถุนุช ุฑุจุงุช
 * @param client ฺฉูุงูุช ุฏุณฺฉูุฑุฏ
 */
export async function forceUpdateStatus(client: any) {
  try {
    await updateBotStatus(client);
    return true;
  } catch (error) {
    log(`ุฎุทุง ุฏุฑ ุจูโุฑูุฒุฑุณุงู ููุฑ ูุถุนุช: ${error}`, 'error');
    return false;
  }
}