/**
 * ุณุณุชู ุชููุฏ ุฌููุงุช ุทูุฒ ู ุณุฑฺฏุฑูโฺฉููุฏู ุชูุณุท ููุด ูุตููุน
 * ุงู ูุงฺูู ุจุฑุง ุชููุฏ ุฌููุงุช ุทูุฒ ู ุณุฑฺฏุฑูโฺฉููุฏู ุจุฑุง ููุงุด ุฏุฑ ุจุฎุด Watching ุฑุจุงุช ุงุณุชูุงุฏู ูโุดูุฏ
 */

import { aiService } from '../services/aiService';
import { log } from '../../vite';

/**
 * ูุณุช ุฌููุงุช ูพุดโูุฑุถ ฺฉูุชุงู ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ ุตูุฑุช ุฎุทุง ุฏุฑ ููุด ูุตููุน
 */
const defaultFunnyStatuses = [
  "ูพุงุชฺฉ ุจู ุฑุฎุชโูุง! ๐งฆ",
  "ูุงฺฉ ฺฉุฑุฏู ุงุณุชูุฑโูุง! โค๏ธ",
  "ูุฑุฎโูุง ุฑูุช ุจุงูุง! ๐",
  "ุบุฑู ุฏุฑ ุณฺฉูโูุง! ๐",
  "ุจุฑุฌโุณุงุฒ ุจุง ุณฺฉู! ๐ข",
  "ุงูููู ุณฺฉู! ๐ค",
  "ุณฺฉูโูุง ฺุดูฺฉโุฒู! โจ",
  "ุฑูุต ุจุง ฺฏุงูโูุง ุจูุฑุณ! ๐",
  "ุดุงู ฺฉู ูพููโูุง! ๐",
  "ููุนูโุณุงุฒ ุจุง ุณฺฉู! ๐ฐ",
  "ููุจุช ุดูุงุณุช! ๐ฏ",
  "ุณุงุฎุช ุงูุชุตุงุฏ ูู! ๐",
  "ุฌุณุชุฌู ฺฏูุฌ! ๐บ๏ธ",
  "ุชุนู ููุช ฺฉูู! ๐",
  "ุฏุฑ ูุงููุฑุช! ๐ต๏ธโโ๏ธ",
  "ฺฉุณู ุณฺฉู ูพุฏุง ฺฉุฑุฏู! ๐คซ",
  "ูุถุงุนู ฺฉุฑุฏู ุณฺฉูโูุง! ๐ฐ",
  "ูุฑุฎโูุง ุฑูุช ุจุงูุง! ๐",
  "ุดูุงุฑุด ุญุณุงุจโูุง! ๐งฎ",
  "ฺุฑุช ุฒุฏู ุจุง ุงูฺฏูุฑุชูโูุง! ๐ด"
];

/**
 * ุชูโูุง ูุฎุชูู ุจุฑุง ุชููุฏ ุฌููุงุช
 */
export const messageThemes = [
  'ุทูุฒ ุงูุชุตุงุฏ',
  'ุจุงุฒ ู ุณุฑฺฏุฑู',
  'ุดูุฎโูุง ุงูุชุฑูุช',
  'ุทูุฒ ุฑูุฒูุฑู',
  'ุฑูุงุจุช ู ฺุงูุด',
  'ููโูุง ฺฉุฑูพุชู',
  'ุซุฑูุช ู ูพูู',
  'ุนุจุงุฑุงุช ูุงูุชุนุงุฑู',
  'ุฏุฒุฏ ู ุณุฑูุช',
  'ุดูุฎโูุง ฺฏูุฑ'
];

/**
 * ุชููุฏ ฺฉ ุฌููู ุทูุฒ ุจุง ุงุณุชูุงุฏู ุงุฒ ููุด ูุตููุน
 * @returns ฺฉ ุฌููู ุทูุฒ ุชููุฏ ุดุฏู ุชูุณุท ููุด ูุตููุน
 */
export async function generateFunnyStatusMessage(): Promise<string> {
  try {
    // ุงูุชุฎุงุจ ฺฉ ุชู ุงุชูุงู
    const randomTheme = messageThemes[Math.floor(Math.random() * messageThemes.length)];
    
    // ุณุงุฎุช ูพุฑุงููพุช ุจุฑุง Hugging Face
    const prompt = `ฺฉ ุฌููู ุฎู ฺฉูุชุงูุ ุทูุฒ ู ุจุงูุฒู ูุงุฑุณ (ุญุฏุงฺฉุซุฑ ตฐ ฺฉุงุฑุงฺฉุชุฑ) ุจุฑุง ููุงุด ุฏุฑ ุจุฎุด "Watching" ฺฉ ุฑุจุงุช ุฏุณฺฉูุฑุฏ ูุฎุตูุต ุจุงุฒ Ccoin (ฺฉ ุจุงุฒ ุงูุชุตุงุฏ) ุชููุฏ ฺฉู.
    
    ุดุฑุงุท ููู:
    - ุฌููู ุจุงุฏ ุญุชูุงู ฺฉูุชุงู ุจุงุดุฏ (ุญุฏุงฺฉุซุฑ ตฐ ฺฉุงุฑุงฺฉุชุฑ)
    - ุฌููู ุจุงุฏ ุญุชูุง ุจู ูุงุฑุณ ู ุจุง ูุญู ุทูุฒ ู ุดูุฎ ุจุงุดุฏ
    - ุงุฒ ุงููุฌ ููุงุณุจ ุงุณุชูุงุฏู ฺฉู (ููุท ฺฉ ุง ุฏู ุงููุฌ)
    - ููุถูุน: ${randomTheme}
    - ุฎู ุฎูุงูุงูู ู ฺฉูุชุงู ู ูุฎุชุตุฑ ุจุงุดุฏ
    - ูุชููู ุจู ุณุจฺฉ ุฌููุงุช ูู ูุงุฑุณ ุจุงุดู
    - ุงุฒ ฺฉููุงุช ู ุงุตุทูุงุญุงุช ุฑุงุฌ ูุงู ฺฏูุฑูุง ู ููุฌูุงูุงู ู ุฌูุงูุงู ุงุฑุงู ุงุณุชูุงุฏู ฺฉู
    - ูุชููู ฺฉู ุดุทูุชโุขูุฒ ุจุงุดู ูู ูุจุงุฏ ุชูููโุขูุฒ ุง ูุงููุงุณุจ ุจุงุดู
    
    ููู: ููุท ุฌููู ููุง ุฑู ุจููุณ ุจุฏูู ูฺ ุชูุถุญ ุงุถุงููโุงุ ู ุญุชูุงู ฺฉูุชุงู ุจุงุดุฏ (ฺฉูุชุฑ ุงุฒ ตฐ ฺฉุงุฑุงฺฉุชุฑ).`;

    // ุฏุฑุงูุช ูพุงุณุฎ ุงุฒ ููุด ูุตููุน
    const generatedMessage = await aiService.getAIResponse(prompt, {
      maxTokens: 100,
      temperature: 0.9 // ุฎูุงูุช ุจุงูุงุชุฑ
    });
    
    // ูพุงฺฉุณุงุฒ ูพุงุณุฎ ุงุฒ ฺฉุงุฑุงฺฉุชุฑูุง ุงุถุงู
    let cleanedMessage = generatedMessage.trim();
    
    // ุงุทููุงู ุงุฒ ุงูฺฉู ูพุงู ุฎู ุทููุงู ูุณุช - ูพุงู ุจุงุฏ ฺฉูุชุงูโุชุฑ ุจุงุดุฏ (ุญุฏุงฺฉุซุฑ 50 ฺฉุงุฑุงฺฉุชุฑ)
    if (cleanedMessage.length > 50) {
      cleanedMessage = cleanedMessage.substring(0, 47) + '...';
    }
    
    log(`ุชููุฏ ูพุงู ุทูุฒ: "${cleanedMessage}"`, 'success');
    
    return cleanedMessage;
  } catch (error) {
    log(`ุฎุทุง ุฏุฑ ุชููุฏ ูพุงู ุทูุฒ: ${error}`, 'error');
    
    // ุงุณุชูุงุฏู ุงุฒ ูพุงูโูุง ูพุดโูุฑุถ ุฏุฑ ุตูุฑุช ุฎุทุง
    const fallbackMessage = defaultFunnyStatuses[Math.floor(Math.random() * defaultFunnyStatuses.length)];
    return fallbackMessage;
  }
}

/**
 * ุชูุธู ุฒูุงูุจูุฏ ุจุฑุง ุจูโุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ ูพุงู ูุถุนุช
 * @param client ฺฉูุงูุช ุฏุณฺฉูุฑุฏ
 * @param intervalMinutes ูุงุตูู ุฒูุงู ุจูโุฑูุฒุฑุณุงู (ุจู ุฏููู)
 */
export function setupAutoStatusUpdater(client: any, intervalMinutes: number = 30) {
  // ุจูโุฑูุฒุฑุณุงู ุงููู ูพุณ ุงุฒ ุฑุงูโุงูุฏุงุฒ
  setTimeout(async () => {
    try {
      updateBotStatus(client);
    } catch (e) {
      log(`ุฎุทุง ุฏุฑ ุจูโุฑูุฒุฑุณุงู ุงููู ูุถุนุช: ${e}`, 'error');
    }
  }, 10000); // 10 ุซุงูู ูพุณ ุงุฒ ุฑุงูโุงูุฏุงุฒ
  
  // ุชูุธู ุจูโุฑูุฒุฑุณุงู ุฏูุฑูโุง
  setInterval(async () => {
    try {
      updateBotStatus(client);
    } catch (e) {
      log(`ุฎุทุง ุฏุฑ ุจูโุฑูุฒุฑุณุงู ุฏูุฑูโุง ูุถุนุช: ${e}`, 'error');
    }
  }, intervalMinutes * 60 * 1000);
  
  log(`ุณุณุชู ุจูโุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ ูุถุนุช ุจุง ูุงุตูู ${intervalMinutes} ุฏููู ุฑุงูโุงูุฏุงุฒ ุดุฏ`, 'info');
}

/**
 * ุจูโุฑูุฒุฑุณุงู ูุถุนุช ููุงุด ุฑุจุงุช
 * @param client ฺฉูุงูุช ุฏุณฺฉูุฑุฏ
 */
async function updateBotStatus(client: any) {
  try {
    const statusMessage = await generateFunnyStatusMessage();
    
    // ุชูุธู ูุถุนุช ุฌุฏุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ ActivityType
    client.user.setActivity(statusMessage, { type: 3 }); // 3 = WATCHING
    
    log(`ูุถุนุช ุฑุจุงุช ุจูโุฑูุฒุฑุณุงู ุดุฏ: ${statusMessage}`, 'info');
  } catch (error) {
    log(`ุฎุทุง ุฏุฑ ุจูโุฑูุฒุฑุณุงู ูุถุนุช ุฑุจุงุช: ${error}`, 'error');
  }
}