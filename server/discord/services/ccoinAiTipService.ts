/**
 * سرویس تولید نکات با استفاده از CCOIN AI
 * این فایل جایگزین هاگینگ فیس شده و از سرویس CCOIN AI (Gemini) استفاده می‌کند
 */

import { generateAIResponse } from './aiService';
import { log } from '../../vite';

// مجموعه موضوعات تخصصی برای تولید نکات
export const tipTopics = [
  "اقتصاد و مدیریت Ccoin",
  "استراتژی‌های بازی و رقابت",
  "ویژگی‌های پنهان ربات",
  "قابلیت‌های جدید",
  "راهکارهای افزایش درآمد",
  "منابع کسب Ccoin",
  "مدیریت کلن‌ها",
  "شخصی‌سازی پروفایل",
  "رازهای موفقیت در بازی‌های گروهی",
  "نکات امنیتی و محافظت از حساب",
  "ترفندهای معاملات",
  "مزایای عضویت در کلن‌ها",
  "نکاتی برای تازه‌واردان",
  "استفاده بهینه از فروشگاه",
  "آیتم‌های ویژه و کاربرد آن‌ها",
  "بازی گرگینه و استراتژی‌های آن",
  "بازی مافیا و تاکتیک‌های پیروزی",
  "بازی بینگو و ترفندهای برنده شدن",
  "جهان‌های موازی و شیوه‌های استفاده",
  "چالش‌های مخفی و جوایز نایاب",
  "سیستم دوستی و افزایش صمیمیت",
  "ماموریت‌های ویژه با پاداش بالا",
  "آیتم‌های کمیاب و نحوه بدست آوردن آن‌ها",
  "ارتقاء حیوانات خانگی مجازی",
  "سیستم‌های مسابقه و تورنمنت‌ها"
];

/**
 * سرویس نکات CCOIN AI
 */
export class CcoinAiTipService {
  /**
   * تولید یک نکته اتفاقی با استفاده از CCOIN AI
   * @returns قول برای دریافت یک نکته تولید شده توسط هوش مصنوعی
   */
  async generateRandomTip(): Promise<string> {
    try {
      // انتخاب یک موضوع اتفاقی از لیست موضوعات
      const randomTopic = tipTopics[Math.floor(Math.random() * tipTopics.length)];
      
      // لاگ کردن موضوع انتخاب شده
      log(`🎲 موضوع اتفاقی برای تولید نکته: ${randomTopic}`, 'discord');
      
      return this.generateTopicTip(randomTopic);
    } catch (error) {
      log(`❌ خطا در تولید نکته هوشمند اتفاقی: ${error}`, 'error');
      
      // در صورت خطا، یک نکته پیش‌فرض برگردان با استایل جذاب
      return "🔥 رفقا! با دستور `/daily` هر روز یه جایزه خفن بگیرین و اگه ۷ روز پشت سر هم بیاین، جوایز ویژه‌ای انتظارتون رو میکشه! 🎁✨ استریک خودتون رو حفظ کنین و لجند باشین! 💯";
    }
  }

  /**
   * تولید یک نکته در مورد موضوع مشخص
   * @param topic موضوع برای تولید نکته
   * @returns قول برای دریافت یک نکته تولید شده توسط هوش مصنوعی
   */
  async generateTopicTip(topic: string): Promise<string> {
    try {
      // ساخت پرامپت برای CCOIN AI با لحن خودمانی و انرژیک
      const prompt = `به عنوان CCOIN AI که دستیار هوشمند و کول ربات Ccoin هستی (یک ربات دیسکورد با سیستم اقتصادی، کلن‌ها، بازی‌های گروهی و حالت‌های مختلف بازی مثل گرگینه، مافیا و بینگو)، 
        یک نکته فوق‌العاده جذاب، خودمانی و کاربردی (حداکثر ۳ جمله) با موضوع "${topic}" ارائه بده.
        
        شرایط مهم:
        1. پاسخ حتماً باید به زبان فارسی و کاملاً خودمانی و صمیمی باشد
        2. حتماً از ایموجی‌های خفن و متنوع استفاده کن (حداقل 7-9 ایموجی) - ایموجی‌های مدرن و ترند روز استفاده کن
        3. لحن پاسخ خیلی خودمانی و جوان‌پسند باشد، مثلاً "بچه‌ها!"، "رفقا"، "داداش"، "گنگ" و غیره استفاده کن
        4. پاسخ فقط شامل متن نکته باشد، بدون عنوان یا مقدمه اضافی
        5. از اصطلاحات محاوره‌ای و جوانانه استفاده کن (مثل "خفن"، "باحال"، "عالیه"، "ایول"، "گنگ"، "لجند" و غیره)
        6. نکته باید فوق‌العاده جذاب، پرانرژی، انگیزشی و خفن باشد - انگار که یک دوست باحال و پر انرژی داره باهات حرف میزنه
        7. اغلب نکته را با کلماتی مثل "آیا می‌دونستی..." یا "نکته‌ی طلایی:..." یا "تو دنیای Ccoin..." شروع کن
        8. از کلمات جذاب و هیجان‌انگیز در نکته استفاده کن تا کاربر را به استفاده از آن قابلیت تشویق کنی
        7. هیچوقت لحن رسمی و خشک نداشته باش
        8. موضوع اصلی نکته رو با حالت‌های بازی و قابلیت‌های جدید ربات مرتبط کن (مثل گرگینه، مافیا، بینگو، جهان‌های موازی، و کوئست‌های جدید)
        9. گاهی به قابلیت خفن ماورالطبیعی خودت اشاره کن - مثلاً اینکه می‌تونی آینده رو ببینی یا همه اتفاقات رو میدونی
        10. حتماً جمله‌هایت را با علامت تعجب و حالت هیجانی تمام کن!
        11. هیچوقت از کلمات "نکته" یا "توصیه" استفاده نکن، مستقیم برو سر اصل مطلب با انرژی`;
      
      // دریافت پاسخ از CCOIN AI
      const response = await generateAIResponse(prompt, 'other', 'خلاقانه');
      
      log(`✅ نکته هوشمند برای موضوع "${topic}" با موفقیت تولید شد`, 'discord');
      log(`🤖 نکته هوشمند با موضوع ${topic} با استفاده از CCOIN AI تولید شد.`);
      
      return response;
    } catch (error) {
      log(`❌ خطا در تولید نکته هوشمند موضوعی: ${error}`, 'error');
      
      // در صورت خطا، یک نکته پیش‌فرض برگردان
      return `💡 ${topic} یکی از ویژگی‌های مهم ربات Ccoin است که به شما کمک می‌کند تجربه بهتری داشته باشید. برای اطلاعات بیشتر از دستور /help استفاده کنید!`;
    }
  }

  /**
   * بررسی وضعیت اتصال به سرویس CCOIN AI
   * @returns وضعیت اتصال به سرویس
   */
  async checkConnectionStatus(): Promise<{
    isAvailable: boolean;
    message: string;
    statusCode: number;
  }> {
    try {
      // تست اتصال به سرویس با یک پرامپت ساده و با کاراکترهای کمتر برای صرفه‌جویی در مصرف API
      const prompt = "فقط عدد 2 را پاسخ بده.";
      const startTime = Date.now();
      
      log(`🧠 در حال تست اتصال به سرویس CCOIN AI...`, 'discord');
      const response = await generateAIResponse(prompt, 'other', 'دقیق');
      const latency = Date.now() - startTime;
      
      if (response) {
        log(`✅ اتصال به سرویس CCOIN AI برقرار است. زمان پاسخگویی: ${latency}ms`, 'discord');
        return {
          isAvailable: true,
          message: `سرویس CCOIN AI در دسترس است. (زمان پاسخ: ${latency}ms)`,
          statusCode: 200
        };
      } else {
        log(`❌ پاسخی از سرویس CCOIN AI دریافت نشد.`, 'error');
        return {
          isAvailable: false,
          message: 'پاسخی از سرویس CCOIN AI دریافت نشد.',
          statusCode: 500
        };
      }
    } catch (error) {
      console.error('Error checking CCOIN AI connectivity:', error);
      log(`❌ خطا در بررسی وضعیت اتصال به سرویس CCOIN AI: ${error}`, 'error');
      return {
        isAvailable: false,
        message: 'خطا در بررسی وضعیت اتصال به سرویس CCOIN AI.',
        statusCode: 500
      };
    }
  }
}

// ایجاد نمونه از سرویس CCOIN AI برای استفاده در سراسر برنامه
export const ccoinAiTipService = new CcoinAiTipService();

export default ccoinAiTipService;