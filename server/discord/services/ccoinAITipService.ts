/**
 * سرویس تولید نکات با استفاده از CCOIN AI
 * این فایل جایگزین هاگینگ فیس شده و از سرویس CCOIN AI (Gemini) استفاده می‌کند
 */

import { generateAIResponse } from './aiService';
import { log } from '../../vite';

// مجموعه موضوعات تخصصی برای تولید نکات - دسته‌بندی دقیق‌تر و منظم‌تر
export const tipTopics = [
  // مدیریت اقتصادی
  "سیستم بانکی Ccoin",  
  "مدیریت سکه‌ها و ذخیره‌سازی",
  "راهکارهای افزایش درآمد روزانه",
  "منابع کسب Ccoin و کریستال",
  "سرمایه‌گذاری در بازار سهام",
  "ترفندهای معاملات و خرید و فروش",
  "سیستم وام‌دهی و قرض",
  
  // سیستم کلن‌ها
  "تشکیل و مدیریت کلن",
  "استراتژی‌های نبرد کلن‌ها",
  "مزایای عضویت در کلن‌ها",
  "ارتقاء کلن و افزایش سطح",
  "نکات مهم برای رهبران کلن",
  "رتبه‌بندی کلن‌ها و رقابت",
  
  // بازی‌های تعاملی
  "استراتژی‌های موفقیت در بازی گرگینه",
  "تاکتیک‌های برنده شدن در بازی مافیا",
  "ترفندهای بازی بینگو",
  "چالش‌های مخفی و جوایز ویژه",
  "راهنمای مینی‌گیم‌ها و بازی‌های شانسی",
  
  // سیستم اجتماعی
  "گسترش روابط دوستی در Ccoin",
  "سیستم هدیه‌دهی به دوستان",
  "چت‌های ناشناس و اصول استفاده",
  "ساختن شبکه اجتماعی در Ccoin",
  
  // امکانات پیشرفته
  "جهان‌های موازی و کاربرد آنها",
  "پت‌های مجازی و نحوه ارتقاء آنها",
  "آیتم‌های کمیاب و روش‌های دستیابی",
  "سیستم دستاوردها و نشان‌ها",
  
  // برای تازه‌واردان
  "شروع قدرتمند در Ccoin",
  "دستورات اساسی برای تازه‌واردان",
  "مسیر پیشرفت سریع در بازی",
  
  // امنیت و تنظیمات
  "محافظت از حساب و سکه‌ها",
  "تنظیمات پیشرفته پروفایل",
  "شخصی‌سازی تجربه بازی"
];

/**
 * سرویس نکات CCOIN AI
 */
export class CcoinAITipService {
  /**
   * تولید یک نکته اتفاقی با استفاده از CCOIN AI
   * @returns قول برای دریافت یک نکته تولید شده توسط هوش مصنوعی
   */
  async generateRandomTip(): Promise<string> {
    try {
      // انتخاب یک موضوع اتفاقی از لیست موضوعات
      const randomTopic = tipTopics[Math.floor(Math.random() * tipTopics.length)];
      
      // لاگ کردن موضوع انتخاب شده
      log(`🎲 موضوع اتفاقی برای تولید نکته: ${randomTopic}`, 'discord');
      
      return this.generateTopicTip(randomTopic);
    } catch (error) {
      log(`❌ خطا در تولید نکته هوشمند اتفاقی: ${error}`, 'error');
      
      // در صورت خطا، یک نکته پیش‌فرض برگردان با استایل جذاب
      return "🔥 رفقا! با دستور `/daily` هر روز یه جایزه خفن بگیرین و اگه ۷ روز پشت سر هم بیاین، جوایز ویژه‌ای انتظارتون رو میکشه! 🎁✨ استریک خودتون رو حفظ کنین و لجند باشین! 💯";
    }
  }

  /**
   * تولید یک نکته در مورد موضوع مشخص
   * @param topic موضوع برای تولید نکته
   * @returns قول برای دریافت یک نکته تولید شده توسط هوش مصنوعی
   */
  async generateTopicTip(topic: string): Promise<string> {
    try {
      // ساخت پرامپت برای CCOIN AI با لحن خودمانی و انرژیک و با تمرکز بیشتر روی موضوع خاص
      const prompt = `به عنوان CCOIN AI که دستیار هوشمند و کول ربات Ccoin هستی (یک ربات دیسکورد با سیستم اقتصادی، کلن‌ها، بازی‌های گروهی و حالت‌های مختلف بازی مثل گرگینه، مافیا و بینگو)، 
        یک نکته فوق‌العاده جذاب، خودمانی و کاربردی (حداکثر ۳ جمله) دقیقاً با موضوع "${topic}" ارائه بده.
        
        شرایط مهم:
        1. محتوای نکته باید دقیقاً مرتبط با موضوع "${topic}" باشد و از موضوع خارج نشود
        2. پاسخ حتماً باید به زبان فارسی و کاملاً خودمانی و صمیمی باشد
        3. حتماً از ایموجی‌های مرتبط و متنوع استفاده کن (حداقل 5-7 ایموجی مرتبط با موضوع)
        4. لحن پاسخ خیلی خودمانی و جوان‌پسند باشد، مثلاً "بچه‌ها!"، "رفقا!"، "دوستان!"
        5. پاسخ فقط شامل متن نکته باشد، بدون عنوان یا مقدمه اضافی
        6. نکته باید فوق‌العاده جذاب، کاربردی و قابل اجرا باشد - اطلاعاتی که کاربر واقعاً بتواند استفاده کند
        7. از اطلاعات غلط یا گمراه‌کننده در مورد قابلیت‌های Ccoin خودداری کن
        8. اغلب نکته را با عباراتی مثل "آیا می‌دونستی..." یا "تو دنیای Ccoin..." شروع کن
        9. توضیحات دقیق و کاربردی در مورد ویژگی‌های خاص مرتبط با "${topic}" ارائه کن
        10. حتماً جمله‌هایت را با علامت تعجب و حالت هیجانی تمام کن!

        مهم: اگر موضوع "${topic}" شامل کلمه "کلن" است، فقط و فقط درباره کلن‌ها و نکات مرتبط با مدیریت، نبرد، یا مزایای کلن‌ها صحبت کن و به هیچ وجه به بازی‌هایی مثل گرگینه یا مافیا اشاره نکن.
        
        اگر موضوع "${topic}" شامل کلمه "گرگینه" است، فقط و فقط درباره بازی گرگینه و استراتژی‌های آن صحبت کن.
        
        اگر موضوع "${topic}" شامل کلمه "مافیا" است، فقط و فقط درباره بازی مافیا و تاکتیک‌های آن صحبت کن.
        
        اگر موضوع "${topic}" شامل کلمه "بینگو" است، فقط و فقط درباره بازی بینگو و ترفندهای آن صحبت کن.
        
        به همین ترتیب، برای هر موضوع، صرفاً به همان موضوع مشخص بپرداز و از موضوع خارج نشو.`;
      
      // دریافت پاسخ از CCOIN AI
      const response = await generateAIResponse(prompt, 'other', 'خلاقانه');
      
      log(`✅ نکته هوشمند برای موضوع "${topic}" با موفقیت تولید شد`, 'discord');
      log(`🤖 نکته هوشمند با موضوع ${topic} با استفاده از CCOIN AI تولید شد.`);
      
      return response;
    } catch (error) {
      log(`❌ خطا در تولید نکته هوشمند موضوعی: ${error}`, 'error');
      
      // در صورت خطا، یک نکته پیش‌فرض برگردان
      return `💡 ${topic} یکی از ویژگی‌های مهم ربات Ccoin است که به شما کمک می‌کند تجربه بهتری داشته باشید. برای اطلاعات بیشتر از دستور /help استفاده کنید!`;
    }
  }

  /**
   * بررسی وضعیت اتصال به سرویس CCOIN AI
   * @returns وضعیت اتصال به سرویس
   */
  async checkConnectionStatus(): Promise<{
    isAvailable: boolean;
    message: string;
    statusCode: number;
  }> {
    try {
      // تست اتصال به سرویس با یک پرامپت ساده و با کاراکترهای کمتر برای صرفه‌جویی در مصرف API
      const prompt = "فقط عدد 2 را پاسخ بده.";
      const startTime = Date.now();
      
      log(`🧠 در حال تست اتصال به سرویس CCOIN AI...`, 'discord');
      const response = await generateAIResponse(prompt, 'other', 'دقیق');
      const latency = Date.now() - startTime;
      
      if (response) {
        log(`✅ اتصال به سرویس CCOIN AI برقرار است. زمان پاسخگویی: ${latency}ms`, 'discord');
        return {
          isAvailable: true,
          message: `سرویس CCOIN AI در دسترس است. (زمان پاسخ: ${latency}ms)`,
          statusCode: 200
        };
      } else {
        log(`❌ پاسخی از سرویس CCOIN AI دریافت نشد.`, 'error');
        return {
          isAvailable: false,
          message: 'پاسخی از سرویس CCOIN AI دریافت نشد.',
          statusCode: 500
        };
      }
    } catch (error) {
      console.error('Error checking CCOIN AI connectivity:', error);
      log(`❌ خطا در بررسی وضعیت اتصال به سرویس CCOIN AI: ${error}`, 'error');
      return {
        isAvailable: false,
        message: 'خطا در بررسی وضعیت اتصال به سرویس CCOIN AI.',
        statusCode: 500
      };
    }
  }
}

// ایجاد نمونه از سرویس CCOIN AI برای استفاده در سراسر برنامه
export const ccoinAITipService = new CcoinAITipService();

export default ccoinAITipService;