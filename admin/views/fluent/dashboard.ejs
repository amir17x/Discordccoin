<h1 class="fluent-page-title">داشبورد</h1>

<div class="fluent-row">
  <!-- کارت آمار سرورها -->
  <div class="fluent-col-3">
    <div class="fluent-card">
      <div class="fluent-card-body fluent-text-center">
        <i class="fas fa-server fa-3x fluent-mb-3" style="color: var(--fluent-primary);"></i>
        <h3><%= stats.totalServers || 0 %></h3>
        <p class="fluent-text-muted">سرورهای فعال</p>
      </div>
    </div>
  </div>
  
  <!-- کارت آمار کاربران -->
  <div class="fluent-col-3">
    <div class="fluent-card">
      <div class="fluent-card-body fluent-text-center">
        <i class="fas fa-users fa-3x fluent-mb-3" style="color: var(--fluent-success);"></i>
        <h3><%= stats.totalUsers || 0 %></h3>
        <p class="fluent-text-muted">کاربران ثبت شده</p>
      </div>
    </div>
  </div>
  
  <!-- کارت آمار تراکنش‌ها -->
  <div class="fluent-col-3">
    <div class="fluent-card">
      <div class="fluent-card-body fluent-text-center">
        <i class="fas fa-exchange-alt fa-3x fluent-mb-3" style="color: var(--fluent-warning);"></i>
        <h3><%= stats.totalTransactions || 0 %></h3>
        <p class="fluent-text-muted">تراکنش‌های امروز</p>
      </div>
    </div>
  </div>
  
  <!-- کارت آمار سکه‌ها -->
  <div class="fluent-col-3">
    <div class="fluent-card">
      <div class="fluent-card-body fluent-text-center">
        <i class="fas fa-coins fa-3x fluent-mb-3" style="color: var(--fluent-primary-dark);"></i>
        <h3><%= stats.totalCoins || 0 %> <small>CCoin</small></h3>
        <p class="fluent-text-muted">کل سکه‌های در گردش</p>
      </div>
    </div>
  </div>
</div>

<div class="fluent-row fluent-mt-4">
  <!-- کارت فعالیت‌های اخیر -->
  <div class="fluent-col-8">
    <div class="fluent-card">
      <div class="fluent-card-header">
        <h3 class="fluent-card-title">
          <i class="fas fa-history"></i>
          فعالیت‌های اخیر
        </h3>
      </div>
      <div class="fluent-card-body">
        <% if (activities && activities.length > 0) { %>
          <div class="fluent-activity-list">
            <% activities.forEach(function(activity) { %>
              <div class="fluent-activity-item">
                <div class="fluent-activity-icon">
                  <i class="<%= activity.icon || 'fas fa-circle' %>"></i>
                </div>
                <div class="fluent-activity-content">
                  <div class="fluent-activity-time"><%= activity.time %></div>
                  <div class="fluent-activity-text"><%= activity.text %></div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="fluent-empty-state">
            <i class="fas fa-info-circle fa-2x fluent-mb-2"></i>
            <p>هیچ فعالیتی ثبت نشده است.</p>
          </div>
        <% } %>
      </div>
      <div class="fluent-card-footer fluent-text-left">
        <a href="/admin/activities" class="fluent-btn fluent-btn-outline fluent-btn-sm">
          مشاهده همه
          <i class="fas fa-arrow-left"></i>
        </a>
      </div>
    </div>
  </div>
  
  <!-- کارت وضعیت سیستم -->
  <div class="fluent-col-4">
    <div class="fluent-card">
      <div class="fluent-card-header">
        <h3 class="fluent-card-title">
          <i class="fas fa-tachometer-alt"></i>
          وضعیت سیستم
        </h3>
      </div>
      <div class="fluent-card-body">
        <div class="fluent-system-status">
          <div class="fluent-status-item">
            <span class="fluent-status-label">وضعیت بازار سهام:</span>
            <span class="fluent-status-value">
              <% if (systemStatus.stockMarket === 'bull') { %>
                <span class="fluent-badge fluent-badge-success">رونق</span>
              <% } else if (systemStatus.stockMarket === 'bear') { %>
                <span class="fluent-badge fluent-badge-danger">رکود</span>
              <% } else { %>
                <span class="fluent-badge fluent-badge-warning">عادی</span>
              <% } %>
            </span>
          </div>
          
          <div class="fluent-status-item">
            <span class="fluent-status-label">نرخ تورم:</span>
            <span class="fluent-status-value"><%= systemStatus.inflationRate || '0' %>%</span>
          </div>
          
          <div class="fluent-status-item">
            <span class="fluent-status-label">وضعیت بانک:</span>
            <span class="fluent-status-value">
              <% if (systemStatus.bankStatus === 'healthy') { %>
                <span class="fluent-badge fluent-badge-success">سالم</span>
              <% } else if (systemStatus.bankStatus === 'risky') { %>
                <span class="fluent-badge fluent-badge-warning">ریسکی</span>
              <% } else { %>
                <span class="fluent-badge fluent-badge-danger">بحرانی</span>
              <% } %>
            </span>
          </div>
          
          <div class="fluent-status-item">
            <span class="fluent-status-label">وضعیت دیسکورد بات:</span>
            <span class="fluent-status-value">
              <% if (systemStatus.botStatus === 'online') { %>
                <span class="fluent-badge fluent-badge-success">آنلاین</span>
              <% } else { %>
                <span class="fluent-badge fluent-badge-danger">آفلاین</span>
              <% } %>
            </span>
          </div>
          
          <div class="fluent-status-item">
            <span class="fluent-status-label">آخرین به‌روزرسانی:</span>
            <span class="fluent-status-value"><%= systemStatus.lastUpdate || 'نامشخص' %></span>
          </div>
        </div>
      </div>
      <div class="fluent-card-footer">
        <button class="fluent-btn fluent-btn-primary fluent-btn-sm fluent-btn-block" id="refresh-status">
          <i class="fas fa-sync-alt"></i>
          به‌روزرسانی وضعیت
        </button>
      </div>
    </div>
    
    <div class="fluent-card fluent-mt-4">
      <div class="fluent-card-header">
        <h3 class="fluent-card-title">
          <i class="fas fa-bullhorn"></i>
          اطلاعیه‌ها
        </h3>
      </div>
      <div class="fluent-card-body">
        <% if (announcements && announcements.length > 0) { %>
          <div class="fluent-announcements">
            <% announcements.forEach(function(announcement) { %>
              <div class="fluent-announcement">
                <div class="fluent-announcement-title"><%= announcement.title %></div>
                <div class="fluent-announcement-date"><%= announcement.date %></div>
                <div class="fluent-announcement-content"><%= announcement.content %></div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="fluent-empty-state">
            <i class="fas fa-info-circle fa-2x fluent-mb-2"></i>
            <p>هیچ اطلاعیه‌ای وجود ندارد.</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<div class="fluent-row fluent-mt-4">
  <!-- کارت تراکنش‌های اخیر -->
  <div class="fluent-col-6">
    <div class="fluent-card">
      <div class="fluent-card-header">
        <h3 class="fluent-card-title">
          <i class="fas fa-exchange-alt"></i>
          تراکنش‌های اخیر
        </h3>
      </div>
      <div class="fluent-card-body">
        <% if (transactions && transactions.length > 0) { %>
          <div class="fluent-table-responsive">
            <table class="fluent-table">
              <thead>
                <tr>
                  <th>نوع</th>
                  <th>کاربر</th>
                  <th>مبلغ</th>
                  <th>تاریخ</th>
                </tr>
              </thead>
              <tbody>
                <% transactions.forEach(function(transaction) { %>
                  <tr>
                    <td>
                      <% if (transaction.type === 'deposit') { %>
                        <span class="fluent-badge fluent-badge-success">واریز</span>
                      <% } else if (transaction.type === 'withdraw') { %>
                        <span class="fluent-badge fluent-badge-danger">برداشت</span>
                      <% } else { %>
                        <span class="fluent-badge"><%= transaction.type %></span>
                      <% } %>
                    </td>
                    <td><%= transaction.user %></td>
                    <td><%= transaction.amount %> CCoin</td>
                    <td><%= transaction.date %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="fluent-empty-state">
            <i class="fas fa-info-circle fa-2x fluent-mb-2"></i>
            <p>هیچ تراکنشی ثبت نشده است.</p>
          </div>
        <% } %>
      </div>
      <div class="fluent-card-footer fluent-text-left">
        <a href="/admin/transactions" class="fluent-btn fluent-btn-outline fluent-btn-sm">
          مشاهده همه
          <i class="fas fa-arrow-left"></i>
        </a>
      </div>
    </div>
  </div>
  
  <!-- کارت تغییرات قیمت سهام -->
  <div class="fluent-col-6">
    <div class="fluent-card">
      <div class="fluent-card-header">
        <h3 class="fluent-card-title">
          <i class="fas fa-chart-line"></i>
          تغییرات قیمت سهام
        </h3>
      </div>
      <div class="fluent-card-body">
        <% if (stocks && stocks.length > 0) { %>
          <div class="fluent-table-responsive">
            <table class="fluent-table">
              <thead>
                <tr>
                  <th>نماد</th>
                  <th>قیمت</th>
                  <th>تغییر</th>
                </tr>
              </thead>
              <tbody>
                <% stocks.forEach(function(stock) { %>
                  <tr>
                    <td><%= stock.symbol %></td>
                    <td><%= stock.price %> CCoin</td>
                    <td>
                      <% if (stock.change > 0) { %>
                        <span class="fluent-text-success">
                          <i class="fas fa-arrow-up"></i>
                          <%= stock.change %>%
                        </span>
                      <% } else if (stock.change < 0) { %>
                        <span class="fluent-text-danger">
                          <i class="fas fa-arrow-down"></i>
                          <%= Math.abs(stock.change) %>%
                        </span>
                      <% } else { %>
                        <span class="fluent-text-muted">
                          <i class="fas fa-minus"></i>
                          0%
                        </span>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="fluent-empty-state">
            <i class="fas fa-info-circle fa-2x fluent-mb-2"></i>
            <p>هیچ سهامی ثبت نشده است.</p>
          </div>
        <% } %>
      </div>
      <div class="fluent-card-footer fluent-text-left">
        <a href="/admin/stock-market" class="fluent-btn fluent-btn-outline fluent-btn-sm">
          مشاهده همه
          <i class="fas fa-arrow-left"></i>
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // دکمه به‌روزرسانی وضعیت
    const refreshButton = document.getElementById('refresh-status');
    if (refreshButton) {
      refreshButton.addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال به‌روزرسانی...';
        this.disabled = true;
        
        // ارسال درخواست به سرور برای به‌روزرسانی وضعیت
        fetch('/admin/api/refresh-status')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // نمایش پیام موفقیت
              showMessage('وضعیت سیستم با موفقیت به‌روزرسانی شد.', 'success');
              
              // بارگذاری مجدد صفحه بعد از 1 ثانیه
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              // نمایش پیام خطا
              showMessage('خطا در به‌روزرسانی وضعیت سیستم: ' + (data.message || 'خطای ناشناخته'), 'danger');
              
              // بازگرداندن دکمه به حالت اولیه
              this.innerHTML = '<i class="fas fa-sync-alt"></i> به‌روزرسانی وضعیت';
              this.disabled = false;
            }
          })
          .catch(error => {
            // نمایش پیام خطا
            showMessage('خطا در ارتباط با سرور: ' + error.message, 'danger');
            
            // بازگرداندن دکمه به حالت اولیه
            this.innerHTML = '<i class="fas fa-sync-alt"></i> به‌روزرسانی وضعیت';
            this.disabled = false;
          });
      });
    }
  });
</script>