<div class="fluent-content-body">
    <div class="fluent-page-header">
        <h1>
            <i class="fa-solid fa-server"></i>
            مدیریت سرورها
        </h1>
        <div class="fluent-page-actions">
            <button class="fluent-button fluent-button-primary" data-toggle="modal" data-target="addServerModal">
                <i class="fa-solid fa-plus ml-2"></i>
                افزودن سرور جدید
            </button>
        </div>
    </div>
    
    <div class="fluent-row">
        <div class="fluent-col-12">
            <div class="fluent-card">
                <div class="fluent-card-header">
                    <h2>لیست سرورهای دیسکورد</h2>
                    <div class="fluent-card-tools">
                        <div class="fluent-search">
                            <input type="text" id="serverSearchInput" class="fluent-search-input fluent-table-search" placeholder="جستجو در سرورها..." data-table="serversTable">
                            <i class="fa-solid fa-search fluent-search-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="fluent-card-body">
                    <div class="fluent-table-responsive">
                        <table class="fluent-table" id="serversTable">
                            <thead>
                                <tr>
                                    <th>آیکون</th>
                                    <th>نام سرور</th>
                                    <th>شناسه سرور</th>
                                    <th>تعداد اعضا</th>
                                    <th>وضعیت</th>
                                    <th>تاریخ اضافه شدن</th>
                                    <th width="150">عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (servers && servers.length > 0) { %>
                                    <% servers.forEach(server => { %>
                                        <tr data-href="/admin/servers/<%= server.serverId %>">
                                            <td>
                                                <div class="fluent-avatar fluent-avatar-sm">
                                                    <% if (server.icon) { %>
                                                        <img src="<%= server.icon %>" alt="<%= server.name %>">
                                                    <% } else { %>
                                                        <div class="fluent-avatar-placeholder">
                                                            <%= server.name.substring(0, 2) %>
                                                        </div>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td><%= server.name %></td>
                                            <td><code><%= server.serverId %></code></td>
                                            <td><%= server.memberCount || 0 %></td>
                                            <td>
                                                <% if (server.active) { %>
                                                    <span class="fluent-badge success">فعال</span>
                                                <% } else { %>
                                                    <span class="fluent-badge danger">غیرفعال</span>
                                                <% } %>
                                            </td>
                                            <td><%= new Date(server.createdAt).toLocaleDateString('fa-IR') %></td>
                                            <td class="fluent-table-actions">
                                                <a href="/admin/servers/<%= server.serverId %>" class="fluent-button fluent-button-sm fluent-button-secondary">
                                                    <i class="fa-solid fa-eye"></i>
                                                </a>
                                                <a href="/admin/servers/<%= server.serverId %>/edit" class="fluent-button fluent-button-sm fluent-button-primary">
                                                    <i class="fa-solid fa-edit"></i>
                                                </a>
                                                <button class="fluent-button fluent-button-sm fluent-button-danger delete-server" data-id="<%= server.serverId %>" data-name="<%= server.name %>">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="7" class="text-center">هیچ سروری یافت نشد. برای افزودن سرور جدید روی دکمه "افزودن سرور جدید" کلیک کنید.</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="fluent-row">
        <div class="fluent-col-6">
            <div class="fluent-card">
                <div class="fluent-card-header">
                    <h2>آمار سرورها</h2>
                </div>
                <div class="fluent-card-body">
                    <div class="fluent-stats-grid">
                        <div class="fluent-stat-item">
                            <div class="fluent-stat-icon bg-primary">
                                <i class="fa-solid fa-server"></i>
                            </div>
                            <div class="fluent-stat-info">
                                <div class="fluent-stat-value"><%= stats?.totalServers || 0 %></div>
                                <div class="fluent-stat-label">تعداد کل سرورها</div>
                            </div>
                        </div>
                        
                        <div class="fluent-stat-item">
                            <div class="fluent-stat-icon bg-success">
                                <i class="fa-solid fa-check-circle"></i>
                            </div>
                            <div class="fluent-stat-info">
                                <div class="fluent-stat-value"><%= stats?.activeServers || 0 %></div>
                                <div class="fluent-stat-label">سرورهای فعال</div>
                            </div>
                        </div>
                        
                        <div class="fluent-stat-item">
                            <div class="fluent-stat-icon bg-danger">
                                <i class="fa-solid fa-times-circle"></i>
                            </div>
                            <div class="fluent-stat-info">
                                <div class="fluent-stat-value"><%= stats?.inactiveServers || 0 %></div>
                                <div class="fluent-stat-label">سرورهای غیرفعال</div>
                            </div>
                        </div>
                        
                        <div class="fluent-stat-item">
                            <div class="fluent-stat-icon bg-info">
                                <i class="fa-solid fa-users"></i>
                            </div>
                            <div class="fluent-stat-info">
                                <div class="fluent-stat-value"><%= stats?.totalMembers || 0 %></div>
                                <div class="fluent-stat-label">مجموع اعضا</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="fluent-col-6">
            <div class="fluent-card">
                <div class="fluent-card-header">
                    <h2>سرورهای افزوده شده اخیر</h2>
                </div>
                <div class="fluent-card-body">
                    <% if (recentServers && recentServers.length > 0) { %>
                        <ul class="fluent-recent-list">
                            <% recentServers.forEach(server => { %>
                                <li class="fluent-recent-item">
                                    <div class="fluent-avatar fluent-avatar-sm">
                                        <% if (server.icon) { %>
                                            <img src="<%= server.icon %>" alt="<%= server.name %>">
                                        <% } else { %>
                                            <div class="fluent-avatar-placeholder">
                                                <%= server.name.substring(0, 2) %>
                                            </div>
                                        <% } %>
                                    </div>
                                    <div class="fluent-recent-info">
                                        <div class="fluent-recent-title"><%= server.name %></div>
                                        <div class="fluent-recent-subtitle">
                                            افزوده شده در <%= new Date(server.createdAt).toLocaleDateString('fa-IR') %>
                                        </div>
                                    </div>
                                    <div class="fluent-recent-actions">
                                        <a href="/admin/servers/<%= server.serverId %>" class="fluent-button fluent-button-sm fluent-button-secondary">
                                            <i class="fa-solid fa-eye"></i>
                                        </a>
                                    </div>
                                </li>
                            <% }); %>
                        </ul>
                    <% } else { %>
                        <div class="fluent-empty-state">
                            <p>هیچ سرور جدیدی اخیراً اضافه نشده است.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- مودال افزودن سرور جدید -->
<div class="fluent-modal" id="addServerModal">
    <div class="fluent-modal-dialog">
        <div class="fluent-modal-content">
            <div class="fluent-modal-header">
                <h5 class="fluent-modal-title">افزودن سرور جدید</h5>
                <button type="button" class="fluent-modal-close" data-dismiss="modal">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="fluent-modal-body">
                <form id="addServerForm" action="/admin/servers/add" method="POST">
                    <div class="fluent-form-group">
                        <label for="serverId" class="fluent-label">شناسه سرور دیسکورد</label>
                        <input type="text" id="serverId" name="serverId" class="fluent-input" placeholder="شناسه 18 رقمی سرور دیسکورد را وارد کنید" required>
                        <div class="fluent-form-hint">شناسه سرور را می‌توانید با کلیک راست روی نام سرور و انتخاب "Copy ID" بدست آورید.</div>
                    </div>
                    
                    <div class="fluent-form-group">
                        <label class="fluent-checkbox">
                            <input type="checkbox" name="active" value="true" checked>
                            <span class="fluent-checkbox-indicator"></span>
                            سرور فعال باشد
                        </label>
                    </div>
                </form>
            </div>
            <div class="fluent-modal-footer">
                <button type="button" class="fluent-button fluent-button-secondary" data-dismiss="modal">انصراف</button>
                <button type="submit" form="addServerForm" class="fluent-button fluent-button-primary">افزودن سرور</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // حذف سرور
    const deleteButtons = document.querySelectorAll('.delete-server');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const serverId = this.dataset.id;
            const serverName = this.dataset.name;
            
            confirmAction(
                `آیا از حذف سرور "${serverName}" اطمینان دارید؟<br>این عملیات غیرقابل بازگشت است.`,
                function() {
                    // ارسال درخواست حذف
                    fetch(`/admin/servers/${serverId}/delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('سرور با موفقیت حذف شد', 'success');
                            // حذف سطر از جدول
                            const row = button.closest('tr');
                            row.remove();
                        } else {
                            showToast(data.message || 'خطا در حذف سرور', 'error');
                        }
                    })
                    .catch(error => {
                        showToast('خطا در برقراری ارتباط با سرور', 'error');
                        console.error('خطا:', error);
                    });
                },
                {
                    title: 'تایید حذف سرور',
                    confirmButtonClass: 'fluent-button-danger',
                    confirmText: 'بله، حذف شود'
                }
            );
        });
    });
});
</script>
